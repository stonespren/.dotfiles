#!/bin/bash

. /etc/os-release

case $ID in
  debian | ubuntu)
    sudo apt install -y neovim git alacritty tmux xclip curl fontconfig build-essential unzip zsh yadm
    ;;

  arch)
    sudo pacman -S --needed git base-devel
    if ! command -v yay >/dev/null 2>&1; then
      # Clean up any previous attempts
      rm -rf /tmp/yay
      cd /tmp
      git clone https://aur.archlinux.org/yay.git
      cd yay
      makepkg -si --noconfirm
      cd "$HOME"
      # Clean up after installation
      rm -rf /tmp/yay
    fi

    yay -S --needed firefox helium-browser-bin discord ghostty yadm neovim tmux visual-studio-code-bin xclip curl fontconfig base-devel unzip zsh update-grub less noto-fonts noto-fonts-cjk noto-fonts-emoji obsidian git-delta flameshot corepdf dragon gwenview fprint lazygit getnf brightnessctl
    ;;

  *) echo "This is an unknown distribution."
    ;;
esac

# Zsh
if [ "$(basename "$SHELL")" != "zsh" ]; then
  chsh -s $(which zsh)
fi

# Zap
if [ ! -d "$HOME/.local/share/zap" ]; then
  zsh <(curl -s https://raw.githubusercontent.com/zap-zsh/zap/master/install.zsh) --branch release-v1 -k
fi

# Tmux Plugin Manager
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
fi

# Use SSH
if [ "$(yadm remote get-url origin)" != "git@github.com:stonespren/.dotfiles.git" ]; then
  yadm remote set-url origin "git@github.com:stonespren/.dotfiles.git"
fi

# Grub Theme
if ! grep -q "GRUB_THEME" /etc/default/grub; then
  git clone https://github.com/HeinrichZurHorstMeyer/Framework-Grub-Theme.git
  sudo cp -r Framework-Grub-Theme/Framework /boot/grub/themes/
  sudo bash -c 'echo "GRUB_THEME=\"/boot/grub/themes/Framework/theme.txt\"" >> /etc/default/grub'
  sudo grub-mkconfig -o /boot/grub/grub.cfg
  sudo update-grub
  rm -rf Framework-Grub-Theme
fi

# Pnpm
if ! command -v pnpm >/dev/null 2>&1; then
  curl -fsSL https://get.pnpm.io/install.sh | sh -
fi


UDEV_RULE_PATH="/etc/udev/rules.d/99-ddc-refresh.rules"
install_udev_rule() {
  if [ -f "$UDEV_RULE_PATH" ]; then
    USERNAME="$(id -un)"
    RULE_CONTENT="ACTION==\"change\", SUBSYSTEM==\"drm\", RUN+=\"/home/$USERNAME/.config/waybar/scripts/update-ddc-buses.sh\""

    if grep -Fxq "$RULE_CONTENT" "$UDEV_RULE_PATH"; then
      echo "✓ DDC udev rule already installed"
      return
    else
      echo "Updating existing DDC udev rule..."
    fi
  else
    echo "Installing DDC udev rule..."
  fi

  echo "$RULE_CONTENT" | sudo tee "$UDEV_RULE_PATH" >/dev/null
  sudo chmod 644 "$UDEV_RULE_PATH"
  sudo udevadm control --reload
  echo "✓ DDC udev rule installed"
}
install_udev_rule

echo "Restart your computer"
